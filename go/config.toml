# Configuration for the RPi Sensor Streamer

[app]
data-producer-loop-ms = 100

[app.topics]
lidar-tof050c = "lidar/tof050c"
imu-1 = "imu/1"

[zeromq]
data-publisher-address = "tcp://127.0.0.1:5559"

[server]
web_port = 8080
bind_ip = "0.0.0.0"
pi_ip = "" # Auto-detected if empty

[webrtc]
# Enable WebRTC
enabled = true
# WebRTC server port for camera 1
webrtc_port_1 = 5557
# WebRTC server port for camera 2
webrtc_port_2 = 5558
# Maximum number of concurrent clients per camera
max_clients = 4
# Target bitrate for video encoding (bits per second)
bitrate = 2000000
# MTU size for RTP packets
mtu = 1200
# WebRTC latency in milliseconds (affects timing calculations)
latency = 200
# Network timeout for WebRTC connections (milliseconds)
timeout = 10000
# STUN server URL for NAT traversal
stun_server = "stun:stun.l.google.com:19302"
# Data channels configuration
data_channels = true
# Codec: "vp8" or "h264"
codec = "h264"

[video]
codec = "h264" # Codec: "vp8" or "h264"
encoder-preset = "fast" # Encoder preset: "realtime", "good", "best"
keyframe-interval = 30 # Keyframe interval in frames
cpu-used = 4 # CPU usage setting for VP8 (lower = higher quality, slower)

[encoding]
codec = "h264"
bitrate = 2000000
keyframe_interval = 30
cpu_used = 4

[camera1]
device = "/base/axi/pcie@1000120000/rp1/i2c@88000/imx219@10"
# Use FullHD resolution for camera1
width = 1920
height = 1080
target-width = 960
target-height = 540
fps = 30
webrtc_port = 5557
flip_method = "vertical-flip"
# Enable scaling for 2:1 downscaling (maintains aspect ratio)
scaling_enabled = true

[camera1.crop]
x = 0
y = 0
width = 1920
height = 1080

[camera2]
device = "/base/axi/pcie@1000120000/rp1/i2c@80000/imx219@10"
# VGA resolution for stable dual-camera streaming
width = 640
height = 480
target-width = 640
target-height = 480
fps = 30
webrtc_port = 5558
flip_method = "vertical-flip"
scaling_enabled = false

[camera2.crop]
x = 0
y = 0
width = 640
height = 480

[lidar-tof050c]
i2c-bus = 1
enable-pin = 17 # GPIO17

[lidar-tof400c]
i2c-bus = 1
enable-pin = 27 # GPIO27
new-i2c-address = 0x2A

[imu-1]
i2c-bus = 0
address = 0x68

# Buffer sizes for channels and queues
[buffers]
frame_channel_size = 20             # Reduced buffer size for FullHD memory management
encoded_channel_size = 15           # Reduced buffer size to prevent memory buildup
signal_channel_size = 1             # Buffer size for signal channels
error_channel_size = 1              # Buffer size for error channels

# Timeout and delay settings
[timeouts]
webrtc_startup_delay_ms = 2000      # Delay before starting cameras after WebRTC servers
camera_startup_delay_ms = 5000      # Increased delay for FullHD hardware stabilization
encoder_sleep_interval_ms = 10      # Sleep interval for encoder loop
shutdown_timeout_seconds = 30       # Timeout for graceful shutdown
http_shutdown_timeout_seconds = 5   # Timeout for HTTP server shutdown

# Logging configuration
[logging]
frame_log_interval = 30             # Log every N frames (0 to disable)
stats_log_interval_seconds = 60     # Interval for stats logging

# Resource limits - optimized for FullHD processing
[limits]
max_memory_usage_mb = 384           # Reduced from 512MB to prevent system memory exhaustion
max_log_files = 15                  # Reduced log file count to save disk space
max_payload_size_mb = 3             # Increased for FullHD frames but with limit

# GStreamer debug configuration for memory leak detection
[debug]
enable_memory_monitoring = true
memory_check_interval_seconds = 30  # More frequent memory checks for FullHD
max_memory_usage_mb = 384           # Match the limits setting
gst_debug_level = 1                 # Further reduced to minimize memory overhead for FullHD

# MJPEG-RTP streaming configuration (alternative to WebRTC)
# Low CPU usage, independent JPEG frames, RTP/UDP transport (RFC 2435)
[mjpeg-rtp]
enabled = false                     # Set to true or use -mode mjpeg-rtp to enable
mtu = 1400                          # MTU for RTP packets (typical Ethernet: 1400-1500)
dscp = 0                            # DSCP QoS marking (0 = best effort, 46 = EF for low latency)
stats_interval_seconds = 10         # Statistics logging interval

# Camera 1 MJPEG-RTP settings
[mjpeg-rtp.camera1]
enabled = true                      # Enable MJPEG-RTP for camera 1
dest_host = "192.168.1.100"         # Destination IP for RTP stream
dest_port = 5000                    # Destination UDP port for camera 1
local_port = 0                      # Local port (0 = auto-assign)
quality = 85                        # JPEG quality (1-100, higher = better quality)
ssrc = 0x12345678                   # RTP SSRC identifier (unique per stream)

# Camera 2 MJPEG-RTP settings
[mjpeg-rtp.camera2]
enabled = true                      # Enable MJPEG-RTP for camera 2
dest_host = "192.168.1.100"         # Destination IP for RTP stream
dest_port = 5002                    # Destination UDP port for camera 2
local_port = 0                      # Local port (0 = auto-assign)
quality = 85                        # JPEG quality (1-100)
ssrc = 0x12345679                   # RTP SSRC identifier (different from camera1)
