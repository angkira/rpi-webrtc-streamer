<!DOCTYPE html>
<html>
<head>
    <title>RPi WebRTC Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        video { width: 640px; height: 480px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .connecting { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .connected { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        #logs { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Raspberry Pi WebRTC Video Stream Test</h1>
    
    <div>
        <label for="serverUrl">Server URL:</label>
        <input type="text" id="serverUrl" value="ws://192.168.5.75:8080" style="width: 300px;">
        <button onclick="connect()" id="connectBtn">Connect</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
    </div>
    
    <div id="status" class="status">Ready to connect</div>
    
    <video id="remoteVideo" autoplay playsinline muted></video>
    
    <h3>Debug Logs:</h3>
    <div id="logs"></div>
    
    <script>
        let ws = null;
        let pc = null;
        let connected = false;
        
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, className) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${className}`;
        }
        
        async function connect() {
            try {
                const serverUrl = document.getElementById('serverUrl').value;
                log(`Connecting to ${serverUrl}...`);
                updateStatus('Connecting...', 'connecting');
                
                ws = new WebSocket(serverUrl);
                
                ws.onopen = async () => {
                    log('WebSocket connected');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    
                    // Create RTCPeerConnection
                    pc = new RTCPeerConnection({
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    });
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            log(`Sending ICE candidate: ${event.candidate.candidate}`);
                            ws.send(JSON.stringify({ iceCandidate: event.candidate }));
                        }
                    };
                    
                    pc.ontrack = (event) => {
                        log(`Received remote track: ${event.track.kind}`);
                        if (event.track.kind === 'video') {
                            remoteVideo.srcObject = event.streams[0];
                            updateStatus('Video stream connected!', 'connected');
                            connected = true;
                        }
                    };
                    
                    pc.onconnectionstatechange = () => {
                        log(`Connection state: ${pc.connectionState}`);
                        if (pc.connectionState === 'connected') {
                            updateStatus('WebRTC connected - waiting for video...', 'connected');
                        } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                            updateStatus('Connection failed or disconnected', 'error');
                        }
                    };
                    
                    // Add transceiver for receiving video
                    pc.addTransceiver('video', { direction: 'recvonly' });
                    
                    // Create offer
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                    log('Created and set local offer');
                    log(`Sending offer with SDP length: ${offer.sdp.length}`);
                    
                    ws.send(JSON.stringify({ offer: offer }));
                };
                
                ws.onmessage = async (event) => {
                    const message = JSON.parse(event.data);
                    
                    if (message.answer) {
                        log('Received SDP answer');
                        const answer = new RTCSessionDescription(message.answer);
                        await pc.setRemoteDescription(answer);
                        log('Set remote description (answer)');
                    } else if (message.iceCandidate) {
                        log(`Received ICE candidate: ${message.iceCandidate.candidate}`);
                        if (pc.remoteDescription) {
                            await pc.addIceCandidate(new RTCIceCandidate(message.iceCandidate));
                        } else {
                            log('Ignoring ICE candidate - no remote description yet');
                        }
                    }
                };
                
                ws.onclose = () => {
                    log('WebSocket disconnected');
                    cleanup();
                };
                
                ws.onerror = (error) => {
                    log(`WebSocket error: ${error}`);
                    updateStatus('Connection error', 'error');
                    cleanup();
                };
                
            } catch (error) {
                log(`Error: ${error}`);
                updateStatus('Connection error', 'error');
                cleanup();
            }
        }
        
        function disconnect() {
            log('Disconnecting...');
            cleanup();
        }
        
        function cleanup() {
            if (ws) {
                ws.close();
                ws = null;
            }
            if (pc) {
                pc.close();
                pc = null;
            }
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            
            connected = false;
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            updateStatus('Disconnected', '');
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html> 