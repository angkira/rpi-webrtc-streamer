name: Deployment Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  pre-deploy-check:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - uses: actions/checkout@v4

      - name: Check for test files
        run: |
          echo "Verifying test infrastructure..."

          if [ ! -f "rust/tests/run_all_tests.sh" ]; then
            echo "‚ùå Test runner missing!"
            exit 1
          fi

          if [ ! -f "rust/tests/integration_test.rs" ]; then
            echo "‚ùå Integration tests missing!"
            exit 1
          fi

          if [ ! -f "rust/tests/browser/test-webrtc.js" ]; then
            echo "‚ùå Browser tests missing!"
            exit 1
          fi

          echo "‚úÖ Test infrastructure present"

      - name: Check documentation
        run: |
          echo "Verifying documentation..."

          if [ ! -f "rust/README.md" ]; then
            echo "‚ùå README missing!"
            exit 1
          fi

          if [ ! -f "rust/TESTING.md" ]; then
            echo "‚ùå Testing documentation missing!"
            exit 1
          fi

          if [ ! -f "rust/config.example.toml" ]; then
            echo "‚ùå Example config missing!"
            exit 1
          fi

          echo "‚úÖ Documentation complete"

      - name: Check configuration
        run: |
          echo "Validating configuration..."

          if [ ! -f "rust/Cargo.toml" ]; then
            echo "‚ùå Cargo.toml missing!"
            exit 1
          fi

          # Check for test dependencies
          if ! grep -q "dev-dependencies" rust/Cargo.toml; then
            echo "‚ùå Test dependencies not configured!"
            exit 1
          fi

          echo "‚úÖ Configuration valid"

      - name: Deployment checklist
        run: |
          echo ""
          echo "=========================================="
          echo "üìã Pre-Deployment Checklist"
          echo "=========================================="
          echo ""
          echo "‚úÖ Test infrastructure present"
          echo "‚úÖ Documentation complete"
          echo "‚úÖ Configuration valid"
          echo ""
          echo "Before merging, ensure:"
          echo "  ‚Ä¢ All tests pass"
          echo "  ‚Ä¢ Code reviewed"
          echo "  ‚Ä¢ Documentation updated"
          echo "  ‚Ä¢ Config examples current"
          echo ""

  test-on-pr:
    name: Run Full Test Suite
    needs: pre-deploy-check
    uses: ./.github/workflows/rust-tests.yml
